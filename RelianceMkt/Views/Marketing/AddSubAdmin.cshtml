@{
    ViewBag.Title = "Create User";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .form-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 9px 24px rgba(0, 0, 0, 0.15);
        width: min(90%, 500px);
        max-width: 580px;
        position: relative;
        margin: 1rem auto;
    }

        .form-container h3 {
            margin-bottom: 1rem;
            font-size: 1.75rem;
            font-weight: 600;
            text-align: center;
            color: #1a1a1a;
        }

    .input-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4a4a4a;
    }

    input, select {
        width: 100%;
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
    }

        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

    .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        cursor: pointer;
        user-select: none;
    }

    button {
        width: 100%;
        padding: 0.875rem;
        background: #007bff;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
    }

        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

    #msg {
        margin-top: 1rem;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
    }

        #msg.success {
            color: #28a745;
        }

        #msg.error {
            color: #dc3545;
        }
</style>

<div class="form-container">
    <h3>Create User</h3>

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <p id="msg" class="error">@ViewBag.ErrorMessage</p>
    }
    else if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
    {
        <p id="msg" class="success">@ViewBag.SuccessMessage</p>
    }

    <div class="input-group">
        <label for="username">Email</label>
        <input type="email" id="username" placeholder="Enter Email" autocomplete="off" required>
    </div>

    <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter password" autocomplete="new-password" required>
        <span class="toggle-password" onclick="togglePassword()">👁️</span>
    </div>

    <div class="input-group">
        <label for="role">Role</label>
        <select id="role" required>
            <option value="">Select Role</option>
            <option value="Sub-Admin(Read-Only)">Sub-Admin (Read-Only)</option>
            <option value="Sub-Admin(Campaign Creator)">Sub-Admin (Campaign Creator)</option>
        </select>
    </div>

    <div class="input-group" id="subchannel-group" style="display:none;">
        <label for="subchannel">SubChannel Name</label>
        <select id="subchannel">
            <option value="">Select SubChannel</option>
            @if (ViewBag.SubChannels != null)
            {
                foreach (var sub in ViewBag.SubChannels)
                {
                    <option value="@sub">@sub</option>
                }
            }
        </select>
    </div>

    <button onclick="createUser()">Submit</button>
    <p id="msg"></p>
</div>

<script>
    function togglePassword() {
        const input = document.getElementById("password");
        const icon = document.querySelector(".toggle-password");
        if (input.type === "password") {
            input.type = "text";
            icon.textContent = "🙈";
        } else {
            input.type = "password";
            icon.textContent = "👁️";
        }
    }

    function showMsg(msg, isError = true) {
        const el = document.getElementById("msg");
        el.textContent = msg;
        el.className = isError ? 'error' : 'success';
    }

    document.getElementById("role").addEventListener("change", function () {
        const role = this.value;
        const subchannelGroup = document.getElementById("subchannel-group");
        const subchannelSelect = document.getElementById("subchannel");

        if (role === "Sub-Admin(Read-Only)") {
            subchannelGroup.style.display = "block";
            subchannelSelect.setAttribute("required", "required");
        } else {
            subchannelGroup.style.display = "none";
            subchannelSelect.removeAttribute("required");
            subchannelSelect.value = "";
        }
    });

    function createUser() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const role = document.getElementById("role").value;
        const subchannel = document.getElementById("subchannel").value;

        if (!username || !password || !role) {
            showMsg("Please fill all required fields");
            return;
        }

        if (role === "Sub-Admin(Read-Only)" && !subchannel) {
            showMsg("Please select a subchannel for Sub-Admin (Read-Only)");
            return;
        }

        fetch('/Marketing/CreateUserAjax', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, role, subchannel: role === "Sub-Admin(Read-Only)" ? subchannel : "" })
        })
            .then(response => response.json())
            .then(data => {
                showMsg(data.message, !data.success);
                if (data.success) {
                    setTimeout(() => {
                        window.location.href = '/Marketing/Index';
                    }, 1000);
                }
            })
            .catch(() => {
                showMsg("Error saving user. Please try again.");
            });
    }
</script>