@{
    ViewBag.Title = "campaign";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .gs-icon {
        font-size: 30px;
        border-radius: 12px;
        height: 47px;
        width: 47px;
        line-height: 47px;
        text-align: center;
        margin-bottom: 5px;
    }
    /* Remove DataTables sorting arrows from table header */
    table.dataTable thead th.sorting,
    table.dataTable thead th.sorting_asc,
    table.dataTable thead th.sorting_desc {
        background-image: none !important;
        padding-right: 10px !important; /* Adjust padding to prevent layout shift */
    }
</style>

<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v15.0&appId=841516383953923&autoLogAppEvents=1" nonce="eIW8JUSQ"></script>

<div class="container-fluid">
    <div class="form-head d-flex mb-0 mb-lg-4 align-items-start">
        <div class="mr-auto d-none d-lg-block">
            <h2 class="text-black font-w600">Campaign</h2>
            <p class="mb-0">Current campaign list</p>
        </div>
        <div class="d-none d-lg-flex align-items-center">
            <div class="text-right">
                @Html.Partial("_PartialDateTime")
            </div>
            @*<a class="ml-4 text-black p-3 rounded border text-center width60" href="#">
                    <i class="las la-cog scale5"></i>
                </a>*@
        </div>
    </div>

    <div class="row">
        <div class="col-xl-12 col-xxl-12 col-lg-12">
           

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Campaign Creatives</h4>
                            <div class="dropdown" style="display: inline-block; position: relative;">
                                <button class="btn btn-secondary" type="button" onclick="window.location.href='@Url.Action("campaignMult","Marketing")'">
                                    ← Back
                                </button>

                                <button class="btn btn-primary" type="button" id="btnActive">Active</button>
                                <button class="btn btn-primary" type="button" id="btnPause">Pause</button>
                                <button class="btn btn-primary" type="button" id="btnStop">Stop</button>
                                <button class="btn btn-primary dropdown-toggle" type="button" id="statusDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Status
                                </button>
                                <div class="dropdown-menu p-3" aria-labelledby="statusDropdown" style="min-width: 200px;">
                                    <div class="form-check">
                                        <input class="form-check-input status-filter" type="checkbox" value="Active" id="statusActive">
                                        <label class="form-check-label" for="statusActive">Active</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input status-filter" type="checkbox" value="Paused" id="statusPaused">
                                        <label class="form-check-label" for="statusPaused">Pause</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input status-filter" type="checkbox" value="Stopped" id="statusStopped">
                                        <label class="form-check-label" for="statusStopped">Stop</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input status-filter" type="checkbox" value="Upcoming" id="statusUpcoming">
                                        <label class="form-check-label" for="statusUpcoming">Upcoming</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card-body" style="padding: 0.875rem" ;>
                            <div class="table-responsive">
                                <table class="table table-responsive-md" id="campaignTable">
                                    <thead>
                                        <tr>
                                            <th style="color: #181f39" ;padding: 0.875rem;>
                                                <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                                                    <input type="checkbox" id="selectAll">All
                                                </label>
                                            </th>
                                            <th style="color: #181f39">ID</th>
                                            <th style="color: #181f39">Channel</th>
                                            <th style="color: #181f39">Creative Caption</th>
                                            <th style="color: #181f39">Status</th>
                                            @*<th><strong>Type</strong></th>*@
                                            <th style="color: #181f39">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in ViewBag.lstAllCampaigns)
                                        {
                                            <tr data-id="@item.campaign_master_id">
                                          


                                                <td><input type="checkbox" class="select-campaign" value="@item.campaign_master_id" /></td>
                                                <td class="row-index"><strong></strong></td>
                                                <td>@item.ChannelName</td>
                                                <td>@item.campaign_master_creative_caption</td>
                                                <td class="campaign-status">
                                                    @if (item.camapaign_master_status == "Paused")
                                                    {
                                                        <span class="badge badge-rounded badge-warning">Paused</span>
                                                    }
                                                    else if (item.camapaign_master_status == "Active")
                                                    {
                                                        <span class="badge badge-rounded badge-success">Active</span>
                                                    }
                                                    else if (item.camapaign_master_status == "Stopped")
                                                    {
                                                        <span class="badge badge-rounded badge-danger">Stopped</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-rounded badge-info">Upcoming</span>
                                                    }
                                                </td>
                                                @*<td>@item.campaign_master_type</td>*@
                                                <td>
                                                    @if (item.camapaign_master_status == "Active" || item.camapaign_master_status == "Paused" || item.camapaign_master_status == "Stopped" || item.camapaign_master_status == "Upcoming")
                                                    {
                                                        <a class="badge badge-rounded badge-success" href="~/Marketing/Editcampaign/@item.campaign_master_id">
                                                            <i class="fa fa-pencil color-info"></i>
                                                        </a>
                                                    }
                                                    <a class="badge badge-rounded badge-primary" href="~/Marketing/campaigndetailsadmin?CampaignMasterId=@item.campaign_master_id">
                                                        <i class="fa fa-eye color-info"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true" id="campaign-modal">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"></h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">


                    <div id="myModalBodyDiv1"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section js
{
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/Content/vendor/jqueryui/js/jquery-ui.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" />



    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var ShowCampaign = function (CampaignMasterId) {
              var url = "/Marketing/campaignDetails?CampaignMasterId=" + CampaignMasterId;
            /*var url = Url.Action("campaignDetails","Marketing",new { CampaignMasterId = CampaignMasterId } );*/

            $("#myModalBodyDiv1").load(url, function () {
                $("#campaign-modal").modal("show");
            });
        }

        $(document).ready(function () {
            var table = $('#campaignTable').DataTable({
                pageLength: 10,
                lengthChange: false,
                info: true,
                paging: false,
                searching: false,
                ordering: false,
                columnDefs: [
                    { orderable: false, targets: [0, 5] },
                    {
                        targets: 1,
                        render: function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    }
                ]
            });

            $('.status-filter').on('change', function () {
                filterTable();
            });

            function filterTable() {
                var selectedStatuses = $('.status-filter:checked').map(function () {
                    return $(this).val();
                }).get();

                table.rows().every(function () {
                    var statusText = $(this.node()).find('.campaign-status').text().trim();
                    if (selectedStatuses.length === 0 || selectedStatuses.includes(statusText)) {
                        this.node().style.display = '';
                    } else {
                        this.node().style.display = 'none';
                    }
                });

                table.draw();
            }

            function getSelectedCampaignIdsAndStatuses() {
                const campaigns = [];
                $('.select-campaign:checked').each(function () {
                    const id = $(this).val();
                    const status = $(this).closest('tr').find('.campaign-status').text().trim();
                    campaigns.push({ id: id, status: status });
                });
                return campaigns;
            }

            function updateStatus(status) {
                const selectedCampaigns = getSelectedCampaignIdsAndStatuses();

                if (selectedCampaigns.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No campaign selected',
                        text: 'Please select at least one campaign.',
                        confirmButtonColor: '#3085d6'
                    });
                    return;
                }

                const validCampaigns = selectedCampaigns.filter(c => c.status !== 'Upcoming');
                if (validCampaigns.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Action Not Allowed',
                        text: 'Selected campaigns are all Upcoming and cannot be modified.',
                        confirmButtonColor: '#3085d6'
                    }).then(() => {
                        location.reload();
                    });
                    return;
                }

                const selectedIds = validCampaigns.map(c => c.id);

                $.ajax({
                    url: '@Url.Action("UpdateStatus", "Marketing")',
                    type: 'POST',
                    traditional: true,
                    data: {
                        campaign_master_id: selectedIds.join(','),
                        campaign_master_status: status
                    },
                    success: function (response) {

                        // 🟡 SPECIAL LOGIC ONLY FOR STOP CASE
                        if (status === 'Stopped') {
                            const hasActiveOrPaused = validCampaigns.some(c => c.status === 'Active' || c.status === 'Paused');
                            if (hasActiveOrPaused) {
                                Swal.fire({
                                    icon: 'info',
                                    title: 'Not Allowed',
                                    text: 'Active or Paused campaigns cannot be changed to Stopped.',
                                    confirmButtonColor: '#3085d6'
                                }).then(() => {
                                    location.reload();
                                });
                                return;
                            }
                        }

                        // ✅ Normal success handling for Active / Paused / Stopped (valid)
                        if (response.success) {
                            validCampaigns.forEach(campaign => {
                                const row = $(`tr[data-id="${campaign.id}"]`);
                                const statusCell = row.find('.campaign-status');
                                const editIcon = row.find('.badge.badge-rounded.badge-success');

                                statusCell.empty();
                                let badgeClass, statusText;  
                                if (status === 'Paused') {
                                    badgeClass = 'badge-warning';
                                    statusText = 'Paused';
                                    editIcon.show();
                                } else if (status === 'Active') {
                                    badgeClass = 'badge-success';
                                    statusText = 'Active';
                                    editIcon.show();
                                } else if (status === 'Stopped') {
                                    badgeClass = 'badge-danger';
                                    statusText = 'Stopped';
                                    editIcon.hide();
                                }
                                statusCell.append(`<span class="badge badge-rounded ${badgeClass}">${statusText}</span>`);
                            });

                            // 🎯 Custom success message for each status
                            let messageText = '';
                            if (status === 'Paused') {
                                messageText = 'Selected campaign(s) have been paused successfully.';
                            } else if (status === 'Active') {
                                messageText = 'Selected campaign(s) have been activated successfully.';
                            } else if (status === 'Stopped') {
                                messageText = 'Selected campaign(s) have been stopped successfully.';
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Status Updated',
                                text: messageText,
                                confirmButtonColor: '#3085d6'
                            }).then(() => {
                                location.reload();
                            });

                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed',
                                text: 'Failed to update campaign status.',
                                confirmButtonColor: '#d33'
                            }).then(() => {
                                location.reload();
                            });
                        }
                    },
                    error: function (xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Something went wrong: ' + xhr.statusText,
                            confirmButtonColor: '#d33'
                        }).then(() => {
                            location.reload();
                        });
                    }
                });
            }

            $('#btnActive').click(function () {
                updateStatus('Active');
            });

            $('#btnPause').click(function () {
                updateStatus('Paused');
            });

            $('#btnStop').click(function () {
                updateStatus('Stopped');
            });

            $('#selectAll').on('change', function () {
                $('.select-campaign').prop('checked', this.checked);
            });
        });
    </script>
    <script>
        function viewSimilarCampaigns(id) {
            // Creates a hidden form to POST selectedCampaignId to your controller
            var form = $('<form action="/Marketing/campaign" method="post">' +
                '<input type="hidden" name="selectedCampaignId" value="' + id + '" />' +
                '</form>');
            $('body').append(form);
            form.submit();
        }
    </script>

}


